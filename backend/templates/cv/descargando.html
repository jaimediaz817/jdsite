{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Descargar CV – Jaime Díaz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1, minimum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">    
    <link rel="shortcut icon" type="image/png" href="{% static 'images/jd_ico.png' %}"/>
    <!-- Fuente Open Sans Ultra Light -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Tus estilos -->
    <link rel="stylesheet" href="{% static 'css/jd_cv.css' %}">
</head>

<body class="jd-cv-bg">

    <div class="jd-cv-container animate-pop">

        <!-- Banner moderno -->
        <div class="jd-mini-banner">CV listo para descargar</div>

        <!-- LOGO + Nombre -->
        <div class="jd-logo-wrapper">
            <img src="{% static 'images/jd.svg' %}" alt="Logo JD">
            <div class="jd-nombre">Jaime Díaz</div>
        </div>

        <!-- Separador elegante -->
        <div class="jd-separador"></div>

        <!-- Título -->
        <h2>Descargar mi CV</h2>

        <!-- Texto principal -->
        <p>
            Gracias por tu interés en mi perfil profesional.  
            Haz clic en el botón para iniciar la descarga.
        </p>
        <div id="cv-info-message" class="jd-info-message" style="display:none;">
            <div class="jd-info-icon">✔</div>
            <span>El CV está disponible en tu carpeta de Descargas.</span>
        </div>       

        <div class="jd-buttons-container">
            <img src="{% static 'images/gifs/descargar.gif' %}" alt="Descarga animada" style="height:38px;vertical-align:middle;margin-right:10px;">
            <!-- Botón principal con loader -->
            <button id="btnDescargar" class="jd-btn-primary">
                <span id="btnTexto">Descargar CV</span>
                <div id="loader" class="jd-loader"></div>
                <span id="check" class="jd-check">✔</span>
            </button>

            <!-- Botón secundario -->
            <a href="{{site_domain}}" class="jd-btn-secondary">
                Visitar mi sitio web
            </a>
        </div>
    </div>

    <!-- Script de comportamiento -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById("btnDescargar");
            const texto = document.getElementById("btnTexto");
            const loader = document.getElementById("loader");
            const check = document.getElementById("check");
            const msgDescarga = document.getElementById("cv-info-message");

            btn.addEventListener("click", () => {
                // 1. Cambiar a modo cargando
                texto.style.display = "none";
                loader.style.display = "inline-block";
                btn.disabled = true; // Evitar doble click

                // 2. Iniciar descarga usando un iframe oculto
                // Esto evita que la página actual cambie o se ponga en blanco
                setTimeout(() => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    // Apuntamos a la URL de Django que tiene as_attachment=True
                    iframe.src = "{% url 'descargar_cv_real' %}"; 
                    document.body.appendChild(iframe);
                    
                    // Limpieza del iframe después de un tiempo prudencial
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                    }, 60000);
                }, 800);

                // 3. Mostrar check de éxito visualmente
                setTimeout(() => {
                    loader.style.display = "none";
                    check.style.display = "inline-block";
                    texto.textContent = "Descargado";
                    texto.style.display = "inline-block";
                    btn.disabled = false;
                    // Mostrar mensaje de descarga
                    msgDescarga.style.display = "flex";                    
                }, 2500);
            });
        });
    </script>
</body>
</html>
